<%@ page contentType="text/html; charset=iso-8859-1" language="java" errorPage=""  pageEncoding="iso-8859-1"%>
<%@ page import="java.sql.ResultSet,Utilerias.UtileriasBDF,Seguridad.SeguridadC, com.ike.asistencias.DAOCostos, com.ike.asistencias.to.Costos;" %>
<html>
    <head>
        <title>Costos</title>
        <link href="../StyleClasses/Global.css" rel="stylesheet" type="text/css">
    </head>
    <body class="cssBody" onload="fnValidaTmp();
            fnLinkPos();
            fnMuestraKMS();/*fnOnLoad()*/">
        <jsp:useBean id="MyUtil" scope="page" class="Utilerias.UtileriasObj" />
        <script src='../Utilerias/Util.js' ></script>
        <script src='../Utilerias/UtilMask.js' ></script>
        <script src='../Utilerias/UtilCostos.js' ></script>
        <script src='../Utilerias/UtilAddCostos.js' ></script>
        <%
            String StrclExpediente = "0";
            StringBuffer StrSql = new StringBuffer();
            String StrclUsrApp = "0";
            String StrclPaginaWeb = "239";
            String StrclCosto = "0";
            String StrclServicio = "";
            String StrTieneTmp = "0";
            String StrComrpobanteTmp = "";
            String StrExisteCosto = "0";

            if (session.getAttribute("clUsrApp") != null) {
                StrclUsrApp = session.getAttribute("clUsrApp").toString();
            }

            if (SeguridadC.verificaHorarioC(Integer.parseInt(StrclUsrApp)) != true) { %>
        Fuera de Horario
        <%
                return;
            }

            if (session.getAttribute("clExpediente") != null) {
                StrclExpediente = session.getAttribute("clExpediente").toString();
            }

            if (request.getParameter("clCosto") != null) {
                StrclCosto = request.getParameter("clCosto").toString();
            }

            if (session.getAttribute("clServicio") != null) {
                StrclServicio = session.getAttribute("clServicio").toString();
            }

            session.setAttribute("clPaginaWebP", StrclPaginaWeb);

            MyUtil.InicializaParametrosC(Integer.parseInt(StrclPaginaWeb), Integer.parseInt(StrclUsrApp));

            StrSql.append("st_getPagoProveedor ").append(StrclCosto);
            ResultSet rsPago = UtileriasBDF.rsSQLNP(StrSql.toString());
            StrSql.delete(0, StrSql.length());

            StrSql.append("st_ValidaCostosTmp ").append(StrclExpediente).append(",").append(StrclCosto);
            System.out.println(StrSql);
            ResultSet rsCostoTmp = UtileriasBDF.rsSQLNP(StrSql.toString());
            StrSql.delete(0, StrSql.length());
            StrSql = null;

            if (rsCostoTmp.next()) {
                StrTieneTmp = rsCostoTmp.getString("TieneTmp");
                StrExisteCosto = rsCostoTmp.getString("ExisteCosto");
                if (StrTieneTmp.equalsIgnoreCase("1")) {
                    StrComrpobanteTmp = rsCostoTmp.getString("Comprobante");
                }
            }
            rsCostoTmp.close();
            rsCostoTmp = null;

            Costos costo = null;
            DAOCostos daoCosto = null;

            if (StrExisteCosto.equalsIgnoreCase("1")) {
                costo = new Costos();
                daoCosto = new DAOCostos();
                costo = daoCosto.getCostos(StrclCosto);
                if (StrTieneTmp.equalsIgnoreCase("0")) {
                    StrComrpobanteTmp = costo.getComprobante();
                }
            }
        %>
        <script>fnOpenLinks()</script>
        <%=MyUtil.doMenuAct("../servlet/Utilerias.ValidaCosto", "fnAccionesAlta()", "fnExcepcion()", "fnGuarda();fnAntesGuarda();fnKMS();")%>
        <INPUT id='URLBACK' name='URLBACK' type='hidden' value='<%=request.getRequestURL().substring(0, request.getRequestURL().lastIndexOf("/") + 1)%>Costos.jsp?'>
        <% if (rsPago.next()) {
                if (rsPago.getString("clPagoProveedor").equalsIgnoreCase("0")) { %>
        <script>
            document.all.btnElimina.disabled = false;
            document.all.btnCambio.disabled = false;
        </script>
        <% } else { %>
        <script>
            document.all.btnElimina.disabled = true;
            document.all.btnCambio.disabled = true;
        </script>
        <% }
            }
            rsPago.close();
            rsPago = null;
        %>
        <INPUT id='clCosto' name='clCosto' type='hidden' value='<%=costo != null ? costo.getClCosto() : '0'%>'>
        <INPUT id='clExpediente' name='clExpediente' type='hidden' value='<%=StrclExpediente%>'>
        <input id='clUsrAppAut' type='hidden' name='clUsrAppAut' value='<%=costo != null ? costo.getClUsrAppAut() : '0'%>'>
        <input id='MotivoAut' type='hidden' name='MotivoAut' value='<%=costo != null ? costo.getMotivoAut() : '0'%>'>
        <input id='clServicio' type='hidden' name='clServicio' value='<%=StrclServicio%>'>
        <INPUT id='Nomina' name='Nomina' type='hidden' value='0'>
        <INPUT id='clCostoxSubservxEF' name='clCostoxSubservxEF' type='hidden' value=''>
        <INPUT id='clCostoXProvXSubserv' name='clCostoXProvXSubserv' type='hidden' value=''>
        <INPUT id='PorcentajeDesc' name='PorcentajeDesc' type='hidden' value=''>
        <INPUT id='CostoRealSEA' name='CostoRealSEA' type='hidden' value=''>       
        <input id='TieneTmp' type='hidden' name='TieneTmp' value='<%=StrTieneTmp%>'>
        <input id='ComprobanteTmp' type='hidden' name='ComprobanteTmp' value='<%=StrComrpobanteTmp%>'>
        <input id='clCategoria' type='hidden' name='clCategoria' value='<%=costo != null ? costo.getClCategoria() : '0'%>'>
        <!-- <input id='Excepcion' type='hidden' name='Excepcion' value='=costo != null ? costo.getExcepcion(): '0'%>'> -->

        <input id='KmRecorridos' type='hidden' name='KmRecorridos' value=''>

        <%=MyUtil.ObjComboC("Proveedor", "clProveedor", costo != null ? costo.getDsProveedor() : "", true, true, 30, 70, "", "sp_LlenaComboProvxExp " + StrclExpediente, "", "", 50, true, true)%>
        <%=MyUtil.ObjComboC("Concepto", "clConcepto", costo != null ? costo.getDsConcepto() : "", true, true, 30, 110, "", "sp_LlenaConceptos " + StrclExpediente + "," + StrclCosto, "fnRegresaCosto();", "", 50, true, true)%>
        <%=MyUtil.ObjComboC("Medio de pago", "clMedioPago", costo != null ? costo.getDsMedioPago() : "", true, false, 420, 110, "", "select clMedioPago,dsMedioPago from cMedioPago where activo = 1", "/*fnCostoT(),*/fnLinkPos()", "", 50, true, false)%>
        <%=MyUtil.ObjInput("Concepto (otro)", "Concepto", costo != null ? costo.getConcepto() : "", true, true, 30, 150, "", false, false, 50)%>
        <%=MyUtil.ObjChkBox("Excepcion", "Excepcion", costo != null ? costo.getExcepcion() : "", true, true, 480, 60, "0", "SI", "NO", "")%>

        <!--%=MyUtil.ObjInput("Costo Total", "CostoTotal", costo != null ? costo.getCostoTotal() : "", false, false, 30, 190, "0", false, false, 7)%-->
        <%=MyUtil.ObjInput("Costo Convenido", "CostoConv", costo != null ? costo.getCostoConv() : "", false, false, 30, 201, "0", false, false, 7, "")%>
        <%=MyUtil.ObjInput("Paga IKE", "CostoSEA", costo != null ? costo.getCostoSEA() : "", true, true, 160, 201, "0", true, true, 7, "fnTotaliza()/*,fnCostoT()*/")%>
        <%=MyUtil.ObjInput("Paga NU<BR>(IVA Incluido)", "CostoNU", costo != null ? costo.getCostoNU() : "", true, true, 250, 190, "0", false, false, 7, "fnTotaliza()/*,fnCostoT()*/")%>                
        <div id="DVKMS" style="visibility: 'hidden'">
            <%=MyUtil.ObjInput("KM NU", "KMExcedente", costo != null ? costo.getKMExcedente() : "0", true, true, 340, 201, "0", false, false, 7, "")%>                
        </div>

        <%=MyUtil.ObjInput("Excedente (informativo)", "CostoExced", costo != null ? costo.getCostoExced() : "", false, false, 420, 201, "0", false, false, 7)%>
        <div class='VTable' style='position:absolute; z-index:25; left:250px; top:80px;'>
            <INPUT type='button' VALUE='Registro de Pago' onClick='this.disabled = true;
                    fnRegistraPago();' class='cBtn'>
        </div>

        <div id="LaPos" style="visibility:'hidden'">
            <%=MyUtil.ObjInput("Nro. Autorizacion", "Comprobante", costo != null ? costo.getComprobante() : "", true, true, 430, 150, "", false, false, 12, "fnValMask(this,document.all.ComprobanteMsk.value,this.name)")%>    
            <a  name="linkPos" href="https://vnet.visa.com.ar/cspv/adm/GetLogin.event "  target="_blank" style="position: absolute; z-index: 555; left: 590px; top: 80px;">
                <img src="../Imagenes/logoLaPos.png" border="0" width='182' height='100' alt="La Pos">
            </a>
        </div>

        <div class='VTable' style='position:absolute; z-index:35; left:710px; top:195px;'>
            <INPUT name ='btnAgregar' type='button' VALUE='Agregar' class='cBtn' onclick ="document.all.btnCancela.disabled = true;
                    document.all.btnAlta.disabled = true;
                    document.all.btnCambio.disabled = true;
                    document.all.btnElimina.disabled = true;
                    fnValida();
                    fnGuarda();
                    fnAntesGuarda();
                    fnKMS();
                    if (msgVal == '') {
                        fnAgrega();
                    } else {
                        alert('Falta informar: ' + msgVal)
                    }" >
        </div>
        <% if (StrclServicio.equals("3")) {%>       
        <%=MyUtil.ObjInput("Descuento %", "PorcentajeDesc", costo != null ? costo.getPorcentajeDesc() : "0", true, true, 30, 230, "0", true, true, 7)%>
        <%=MyUtil.ObjInput("Costo Real IKE", "CostoRealSEA", costo != null ? costo.getCostoRealSEA() : "0", false, false, 170, 230, "0", false, false, 7, "")%>
        <div class='VTable' style='position:absolute; z-index:20; left:300px; top:240px;'>
            <INPUT type='button' VALUE='Realiza Descuento' onClick='fnPorcentaje()' class='cBtn'>
        </div>
        <%}%>

        <input name='ComprobanteMsk' id='ComprobanteMsk' type='hidden' value='VN09VN09VN09VN09VN09VN09'>

        <BR><BR><BR><BR><BR><BR><BR><BR><BR><BR><BR><BR><BR><BR><BR><BR>
        <iframe name="Listado de Costos" id="ListadoCostos" src="ListaCostosTmp.jsp" align="left" width="100%" height="50%"></iframe>

        <%=MyUtil.DoBlock("Costo", 130, 10)%>
        <%=MyUtil.GeneraScripts()%>

        <script>

            function fnValidaTmp() {
                if (document.all.TieneTmp.value == '1') {
                    document.all.Action.value = 1;
                    document.all.btnGuarda.disabled = false;
                    document.all.btnCancela.disabled = false;
                    document.all.btnAlta.disabled = true;
                    document.all.btnCambio.disabled = true;
                    document.all.btnElimina.disabled = true;
                    fnHabilitaA();
                    fnAccionesAlta()
                }
            }

            function fnAccionesAlta() {
                if (document.all.clServicio.value == "1") {
                    document.all.Concepto.ReadOnly = true;
                }
                document.all.forma.action = "../servlet/Utilerias.ValidaCosto";
                document.all.btnAgregar.disabled = false;
                document.all.LaPos.style.visibility = 'hidden';

                var strConsulta = "sp_LlenaConceptos " + document.all.clExpediente.value + ",0";
                var pstrCadena = "../servlet/Utilerias.LlenaCombos?strSQL=" + strConsulta;
                pstrCadena = pstrCadena + "&strName=clConceptoC";
                fnOptionxDefault('clConceptoC', pstrCadena);
            }

            function fnAntesGuarda() {
                if (document.all.clMedioPago.value == "2" && document.all.Comprobante.value == "") {
                    msgVal = msgVal + " Comprobante";
                    document.all.btnGuarda.disabled = false;
                    document.all.btnCancela.disabled = false;
                }
            }

            function fnGuarda() {
                if ((document.all.clServicio.value != "1") && (document.all.Concepto.value == '')) {
                    msgVal = msgVal + " Concepto (otro). ";
                }
            }

            function fnSubmitOK(pclUsr, pMotivo) {
                document.all.clUsrAppAut.value = pclUsr;
                document.all.MotivoAut.value = pMotivo;
                document.all.forma.action = "../servlet/Utilerias.EjecutaAccion";
                document.all.forma.submit();
            }

            function fnAgrega() {
                document.all.forma.action = "../servlet/Utilerias.ValidaCostoTmp";
                this.disabled = true;
                document.all.btnCancela.disabled = true;
                document.all.btnAlta.disabled = true;
                document.all.btnCambio.disabled = true;
                document.all.btnElimina.disabled = true;
                fnValida();
                fnGuarda();
                if (msgVal == '') {
                    fnOpenWindow();
                    document.all.forma.submit();
                } else {
                    alert('Falta informar: ' + msgVal)
                }
                //document.all.forma.submit();
            }

            function fnPago() {
                alert('Pago Registrado');
                document.all.PendientePagoC.checked = false;
            }

            function fnTotaliza() {
                if (document.all.Action.value != '') {
                    CostoExcedente = eval(parseFloat(document.all.CostoSEA.value) + parseFloat(document.all.CostoNU.value) - parseFloat(document.all.CostoConv.value));
                    if (CostoExcedente < 0) {
                        CostoExcedente = 0;
                    }
                    document.all.CostoExced.value = CostoExcedente;
                    //document.all.CostoRealSEA.value=document.all.CostoSEA.value;
                }
            }

            function fnPorcentaje() {
                // Rango 0-100
                if (document.all.PorcentajeDesc.value < 0) {
                    alert('Porcentaje debe ser entre 0 y 100');
                    document.all.PorcentajeDesc.value = 0;
                }
                if (document.all.PorcentajeDesc.value > 100) {
                    alert('Porcentaje debe ser entre 0 y 100');
                    document.all.PorcentajeDesc.value = 0;
                }
                //Calcular porcentaje
                document.all.CostoRealSEA.value = document.all.CostoSEA.value;
                CostoReal = eval(parseFloat(document.all.CostoRealSEA.value) - parseFloat(document.all.CostoRealSEA.value) * parseFloat(document.all.PorcentajeDesc.value) / 100);
                if (CostoReal < 0) {
                    CostoReal = 0;
                }
                document.all.CostoSEA.value = CostoReal;
                CostoExcedente = eval(parseFloat(document.all.CostoSEA.value) + parseFloat(document.all.CostoNU.value) - parseFloat(document.all.CostoConv.value));
                if (CostoExcedente < 0) {
                    CostoExcedente = 0;
                }
                document.all.CostoExced.value = CostoExcedente;
            }

            /*function fnCostoT() {
             if (document.all.Action.value != '') {
             if (document.all.clMedioPago.value == "1") {
             document.all.CostoTotal.value = document.all.CostoSEA.value;
             } else {
             if (document.all.clMedioPago.value == "2") {
             document.all.CostoTotal.value = eval(parseFloat(document.all.CostoSEA.value) + parseFloat(document.all.CostoNU.value));
             }
             }
             }
             }*/

            function fnLinkPos() {
                if (document.all.clMedioPago.value == "1") {
                    document.all.LaPos.style.visibility = 'hidden';
                    document.all.Comprobante.value = "";
                    document.all.CostoNU.disabled = false;
                } else if (document.all.clMedioPago.value == "2") {
                    document.all.LaPos.style.visibility = 'visible';
                    document.all.Comprobante.value = document.all.ComprobanteTmp.value;
                    document.all.CostoNU.disabled = false;
                } else if (document.all.clMedioPago.value == "3") {
                    document.all.LaPos.style.visibility = 'hidden';
                    document.all.Comprobante.value = "";
                    document.all.CostoNU.disabled = true;
                    document.all.CostoNU.value = "0";
                    fnTotaliza();
                }
            }

            function fnReload() {
                location.reload();
            }

            function fnKMS() {
                if (document.all.clCategoria.value != '3') {
                    document.all.KMExcedente.value = '0';
                } else {
                    if (document.all.CostoNU.value != '0' && document.all.CostoNU.value != '0.00' && document.all.CostoNU.value != '') {
                        if (document.all.KMExcedente.value == '0' || document.all.KMExcedente.value == '0.00' || document.all.KMExcedente.value == '') {
                            msgVal = 'KM NU no puede quedar en Cero.';
                            document.all.btnGuarda.disabled = false;
                            document.all.btnCancela.disabled = false;
                        }
                    }
                }

                if (document.all.clCategoria.value == '3' || document.all.clCategoria.value == '4') {
                    if (parseFloat(document.all.CostoConv.value) == '0.00') {
                        msgVal = 'Costo Convenido es igual a 0.';
                    } else {
                        KMRecorridos = eval(parseFloat(document.all.CostoSEA.value) / parseFloat(document.all.CostoConv.value));
                        if (KMRecorridos < 0) {
                            KMRecorridos = 0;
                        }
                        document.all.KmRecorridos.value = KMRecorridos;
                    }
                }
            }

            function fnMuestraKMS() {
                if (document.all.clCategoria.value == '3') {
                    document.getElementById('DVKMS').style.visibility = 'visible';
                } else {
                    document.getElementById('DVKMS').style.visibility = 'hidden';
                }
            }

            function fnExcepcion() {
                //alert("Excepcion: " + document.getElementById("Excepcion").value)
                if (document.getElementById("Excepcion").value == 1) {
                    //document.getElementById("divExcepcion").disabled = true;
                    document.all.ExcepcionC.disabled = true;
                } else {
                    document.all.ExcepcionC.disabled = false;
                }
            }
        </script>
    </body>
</html>