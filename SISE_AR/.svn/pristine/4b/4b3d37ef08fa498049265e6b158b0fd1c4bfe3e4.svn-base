<%@ page contentType="text/html; charset=iso-8859-1" language="java" import="java.sql.ResultSet,Utilerias.UtileriasBDF,Seguridad.SeguridadC" errorPage="" %>
<html>
    <head>
        <title>Seguimiento</title>
    </head>
    <body class="cssBody">
        <link href="../StyleClasses/Global.css" rel="stylesheet" type="text/css">
        <jsp:useBean id="MyUtil" scope="page" class="Utilerias.UtileriasObj"/>
        <script src='../Utilerias/Util.js'></script>
        <script src='../Utilerias/UtilProveedor.js'></script>
        <%
            String StrclExpediente = "0";
            String strclUsrApp = "0";
            StringBuffer StrSql = new StringBuffer();
            String StrclPaginaWeb = "195";
            String StrclServicio = "0";

            if (session.getAttribute("clUsrApp") != null) {
                strclUsrApp = session.getAttribute("clUsrApp").toString();
            }
            
            if (session.getAttribute("clServicio") != null) {
                StrclServicio = session.getAttribute("clServicio").toString();
            }
            
            if (SeguridadC.verificaHorarioC(Integer.parseInt(strclUsrApp)) != true) {
                %>Fuera de Horario<%
                return;
            }

            if (session.getAttribute("clExpediente") != null) {
                StrclExpediente = session.getAttribute("clExpediente").toString();
            }

            session.setAttribute("clPaginaWebP", StrclPaginaWeb);

            MyUtil.InicializaParametrosC(195, Integer.parseInt(strclUsrApp));

            // checar si ya existe asistencia para el expediente, si existe, ya no procede la alta
            StrSql.append(" Select TieneAsistencia From Expediente Where clExpediente = ").append(StrclExpediente);

            ResultSet rs = UtileriasBDF.rsSQLNP(StrSql.toString());
            StrSql.delete(0, StrSql.length());
            StrSql = null;

            if (rs.next()) { %>
            <form name='frmExp' id='frmExp' method='get' action='../servlet/Utilerias.GuardaSeguimiento'>

                <%=MyUtil.ObjComboC("Estatus", "clEstatus0", "", true, true, 30, 30, "", "sp_GetEstatusOp '" + StrclExpediente + "'", "fnValidaEstatus(this.value);fnLlenaComboMotivo(this.value);", "", 50, false, false)%>
                <div id="MotivoDIV" style="visibility:'hidden'">
                    <%=MyUtil.ObjComboC("Motivo", "clMotivo0", "", true, true, 230, 30, "", "st_MotivoxEstatusSeg 0", "fnValidaMotivo(this.value)", "", 50, false, false)%>
                </div>
                <%=MyUtil.ObjTextArea("Observaciones", "Observaciones0", "", "100", "7", true, true, 30, 70, "", false, false)%>
                <INPUT id='URLBACK0' name='URLBACK0' type='hidden' value='<%=request.getRequestURL().substring(0, request.getRequestURL().lastIndexOf("/") + 1)%>DetalleExpediente.jsp?clExpediente=<%=StrclExpediente%>'></input>
                <INPUT id='clExpediente0' name='clExpediente0' type='hidden' value='<%=StrclExpediente%>'>
                <INPUT id='TipoSeg0' name='TipoSeg0' type='hidden' value='0'>        
                <%=MyUtil.DoBlock("Seguimiento al Servicio", 137, 90)%>

                <div class='VTable' style='position:absolute; z-index:20; left:30px; top:180px;'>
                    <INPUT type='button' name="btnGuarda0" VALUE='Guardar...' onClick='this.disabled = true;
                            this.form.submit();' class='cBtn'>
                </div>
            </form>

            <form name='frmProv' id='frmExp' method='get' action='../servlet/Utilerias.GuardaSeguimiento'>
                <!-- Nota: En el siguiente combo, se crea una subconsulta ya que en linux el tomcat tiene problemas si la tabla tiene muchos campos y entre ellos uno de tipo text. -->
                <%=MyUtil.ObjComboC("Proveedor", "clProveedor1", "", true, true, 30, 250, "", "st_getSegProveedores " + StrclExpediente, "fnLlenaEstatusProv()", "", 30, false, false)%>
                <%=MyUtil.ObjComboC("Estatus", "clEstatus1", "", true, true, 30, 290, "", "sp_GetEstatusOp '0'", "", "", 50, false, false)%>
                <%=MyUtil.ObjTextArea("Observaciones", "Observaciones1", "", "100", "7", true, true, 30, 330, "", false, false)%>
                <INPUT id='URLBACK1' name='URLBACK1' type='hidden' value='<%=request.getRequestURL().substring(0, request.getRequestURL().lastIndexOf("/") + 1)%>DetalleExpediente.jsp?clExpediente=<%=StrclExpediente%>'></input>
                <INPUT id='clExpediente1' name='clExpediente1' type='hidden' value='<%=StrclExpediente%>'>
                <INPUT id='TipoSeg1' name='TipoSeg1' type='hidden' value='1'>

                <%=MyUtil.DoBlock("Seguimiento al Proveedor", 340, 90)%>

                <div class='VTable' style='position:absolute; z-index:20; left:30px; top:440px;'>
                    <INPUT type='button' VALUE='Guardar...' onClick='this.disabled = true;
                            this.form.submit();' class='cBtn'>
                </div>
            </form>
        <% } else { %> 
            El expediente no existe 
            <%
            }
            rs.close();
            rs = null;

            StrclExpediente = null;
            strclUsrApp = null;
        %>
    </body>
    <script>
        document.all.clEstatus0C.disabled = false;
        document.all.Observaciones0.readOnly = false;
        document.all.clMotivo0C.disabled = false;
        document.all.clProveedor1C.disabled = false;
        document.all.clEstatus1C.disabled = false;
        document.all.Observaciones1.readOnly = false;


        function fnValidaEstatus(clEstatus) {
            if ((clEstatus == '46') || (clEstatus == '7') || (clEstatus == '8') || (clEstatus == '10' && <%=StrclServicio%> == '19')) {
                document.all.MotivoDIV.style.visibility = 'visible';
                document.all.btnGuarda0.disabled = true;
            } else {
                document.all.MotivoDIV.style.visibility = 'hidden';
                document.all.btnGuarda0.disabled = false;
            }
        }

        function fnValidaMotivo(clMotivo) {
            if (clMotivo != '') {
                document.all.btnGuarda0.disabled = false;
            } else {
                document.all.btnGuarda0.disabled = true;
            }
        }

        function fnLlenaComboMotivo(clEstatus) {
            if ((clEstatus == '46') || (clEstatus == '7') || (clEstatus == '8') || (clEstatus == '10')) {
                var strConsulta = "st_MotivoxEstatusSeg '" + document.all.clEstatus0.value + "'";
                var pstrCadena = "../servlet/Utilerias.LlenaCombos?strSQL=" + strConsulta;
                pstrCadena = pstrCadena + "&strName=clMotivo0C";
                fnOptionxDefault('clMotivo0C', pstrCadena);
            }
        }
    </script>
</html>